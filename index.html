<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tools Professional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ===== RESET & ROOT ===== */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --ink: #0f0f12;
            --ink-soft: #3a3a4a;
            --ink-muted: #7a7a8e;
            --surface: #ffffff;
            --surface-2: #f4f4f8;
            --surface-3: #eaeaf0;
            --accent: #4f46e5;
            --accent-hover: #4338ca;
            --accent-light: #ede9fe;
            --accent-glow: rgba(79,70,229,0.15);
            --success: #059669;
            --success-light: #d1fae5;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --warn: #d97706;
            --warn-light: #fef3c7;
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.14), 0 2px 8px rgba(0,0,0,0.06);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: #0f0f1a;
            min-height: 100vh;
            color: var(--ink);
        }

        /* ===== VIEWS ===== */
        .view { display: none; }
        .view.active { display: flex; flex-direction: column; min-height: 100vh; }

        /* ===== LANDING PAGE ===== */
        #landing {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a35 40%, #0f1628 100%);
            align-items: center;
            justify-content: center;
            padding: 60px 24px;
            position: relative;
            overflow: hidden;
        }

        #landing::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 30%, rgba(79,70,229,0.25) 0%, transparent 55%),
                radial-gradient(ellipse at 80% 70%, rgba(124,58,237,0.18) 0%, transparent 55%),
                radial-gradient(ellipse at 50% 10%, rgba(59,130,246,0.12) 0%, transparent 45%);
            pointer-events: none;
        }

        .landing-content {
            position: relative;
            z-index: 1;
            text-align: center;
            max-width: 900px;
            width: 100%;
        }

        .landing-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(79,70,229,0.2);
            border: 1px solid rgba(79,70,229,0.4);
            border-radius: 100px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #a5b4fc;
            margin-bottom: 28px;
            letter-spacing: 0.02em;
        }

        .landing-title {
            font-size: clamp(36px, 6vw, 64px);
            font-weight: 700;
            color: #ffffff;
            line-height: 1.1;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }

        .landing-title span {
            background: linear-gradient(135deg, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .landing-sub {
            font-size: 18px;
            color: rgba(255,255,255,0.55);
            max-width: 520px;
            margin: 0 auto 52px;
            line-height: 1.6;
        }

        .tool-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            max-width: 760px;
            margin: 0 auto;
        }

        .tool-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 36px 32px;
            text-align: left;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
        }

        .tool-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.25s;
        }

        .tool-card.separator::before { background: radial-gradient(circle at 0% 0%, rgba(79,70,229,0.2), transparent 60%); }
        .tool-card.annotator::before { background: radial-gradient(circle at 0% 0%, rgba(124,58,237,0.2), transparent 60%); }

        .tool-card:hover {
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .tool-card:hover::before { opacity: 1; }

        .tool-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .tool-card.separator .tool-icon { background: rgba(79,70,229,0.2); }
        .tool-card.annotator .tool-icon { background: rgba(124,58,237,0.2); }

        .tool-card-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .tool-card-desc {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .tool-card-features {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 28px;
        }

        .tool-card-features li {
            font-size: 13px;
            color: rgba(255,255,255,0.45);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-card-features li::before {
            content: '‚úì';
            color: #818cf8;
            font-weight: 700;
            font-size: 12px;
        }

        .tool-card-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-card.separator .tool-card-btn {
            background: rgba(79,70,229,0.25);
            color: #a5b4fc;
        }

        .tool-card.annotator .tool-card-btn {
            background: rgba(124,58,237,0.25);
            color: #c4b5fd;
        }

        .tool-card:hover .tool-card-btn {
            background: var(--accent);
            color: white;
        }

        /* ===== COMMON APP CHROME ===== */
        .app-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--surface-3);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        .app-bar-back {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--surface-3);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--ink-muted);
            transition: all 0.15s;
        }

        .app-bar-back:hover {
            background: var(--surface-2);
            color: var(--ink);
        }

        .app-bar-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--ink);
        }

        .app-bar-spacer { flex: 1; }

        /* ===== BUTTON BASE ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { background: var(--surface-3); color: var(--ink-muted); cursor: not-allowed; }

        .btn-ghost {
            background: transparent;
            color: var(--ink-soft);
            border: 1px solid var(--surface-3);
        }
        .btn-ghost:hover { background: var(--surface-2); color: var(--ink); }

        .btn-danger {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid rgba(220,38,38,0.2);
        }
        .btn-danger:hover { background: var(--danger); color: white; }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: var(--radius-sm);
        }

        /* ===== TOAST ===== */
        #toast {
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%) translateY(16px);
            background: var(--ink);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            z-index: 9999;
            pointer-events: none;
            max-width: 380px;
            text-align: center;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ===== LOADING OVERLAY ===== */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,15,26,0.75);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            backdrop-filter: blur(4px);
            display: none;
        }
        #loading-overlay.show { display: flex; }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255,255,255,0.15);
            border-top-color: #818cf8;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-bottom: 16px;
        }

        .loading-text {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== MODAL ===== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(4px);
        }
        .modal-backdrop.hidden { display: none; }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 24px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--ink);
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: none;
            background: var(--surface-2);
            cursor: pointer;
            font-size: 16px;
            color: var(--ink-muted);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 0 24px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ===== FORM ELEMENTS ===== */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--ink-soft);
            margin-bottom: 6px;
        }
        .form-control {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--surface-3);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: inherit;
            color: var(--ink);
            background: var(--surface);
            outline: none;
            transition: border-color 0.15s;
        }
        .form-control:focus { border-color: var(--accent); }
        select.form-control { cursor: pointer; }

        /* =========================================================
           PDF SEPARATOR TOOL
        ========================================================= */
        #separator { background: #f0f0f6; }
        #separator.view.active { display: flex; }

        .sep-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* --- Upload zone --- */
        .upload-zone-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
        }

        .upload-zone {
            width: 100%;
            max-width: 540px;
            background: var(--surface);
            border: 2px dashed var(--surface-3);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .upload-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 8px;
        }

        .upload-sub {
            font-size: 14px;
            color: var(--ink-muted);
            margin-bottom: 24px;
        }

        /* --- Toolbar --- */
        .sep-toolbar {
            background: var(--surface);
            border-bottom: 1px solid var(--surface-3);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .sep-toolbar-sep {
            width: 1px;
            height: 24px;
            background: var(--surface-3);
        }

        .sep-toolbar label {
            font-size: 13px;
            font-weight: 500;
            color: var(--ink-soft);
        }

        .bulk-category-select {
            padding: 6px 10px;
            border: 1px solid var(--surface-3);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-family: inherit;
            color: var(--ink);
            background: var(--surface-2);
            cursor: pointer;
            outline: none;
        }

        .progress-bar-wrap {
            flex: 1;
            min-width: 120px;
            max-width: 260px;
            height: 6px;
            background: var(--surface-3);
            border-radius: 100px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #818cf8);
            border-radius: 100px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: var(--ink-muted);
            white-space: nowrap;
        }

        /* --- Grid --- */
        .sep-grid-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .sep-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .page-card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            border: 2px solid transparent;
        }
        .page-card:active { cursor: grabbing; }
        .page-card.drag-over-card { border-color: var(--accent); transform: scale(1.02); }
        .page-card.dragging { opacity: 0.4; }

        .page-thumb {
            width: 100%;
            aspect-ratio: 3/4;
            background: var(--surface-2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .page-thumb canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        .page-thumb-placeholder {
            font-size: 32px;
            opacity: 0.4;
        }

        .page-actions {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .page-card:hover .page-actions { opacity: 1; }

        .page-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 7px;
            border: none;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(4px);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            transition: all 0.15s;
            color: var(--ink-soft);
        }
        .page-action-btn:hover { background: var(--surface); color: var(--ink); transform: scale(1.1); }

        .page-info {
            padding: 10px 12px;
        }

        .page-num {
            font-size: 12px;
            font-weight: 600;
            color: var(--ink-muted);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .flip-indicator {
            font-size: 10px;
            color: var(--warn);
            background: var(--warn-light);
            padding: 1px 5px;
            border-radius: 4px;
            display: none;
        }

        .page-category-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--surface-3);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-family: inherit;
            color: var(--ink);
            background: var(--surface-2);
            cursor: pointer;
            outline: none;
        }
        .page-category-select:focus { border-color: var(--accent); }

        /* =========================================================
           PDF ANNOTATOR TOOL
        ========================================================= */
        #annotator {
            background: #2a2a3e;
            display: none;
            flex-direction: column;
        }
        #annotator.view.active { display: flex; }

        /* -- Menu Bar -- */
        .ann-menubar {
            background: #1e1e2e;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            height: 36px;
            display: flex;
            align-items: center;
            gap: 0;
            flex-shrink: 0;
            padding: 0 12px;
        }

        .ann-menu-btn {
            padding: 4px 12px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .ann-menu-btn:hover { background: rgba(255,255,255,0.08); color: white; }

        .ann-menubar-spacer { flex: 1; }

        .ann-back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
        }
        .ann-back-btn:hover { background: rgba(255,255,255,0.08); color: white; }

        /* -- Toolbar -- */
        .ann-toolbar {
            background: #252535;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            height: 48px;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .ann-tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.55);
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
        }
        .ann-tool-btn:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.9); }
        .ann-tool-btn.active { background: rgba(99,102,241,0.3); color: #a5b4fc; }

        .ann-toolbar-sep {
            width: 1px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            margin: 0 4px;
        }

        .ann-color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.25);
            cursor: pointer;
            transition: transform 0.15s;
        }
        .ann-color-swatch:hover { transform: scale(1.15); }

        .ann-size-slider {
            width: 80px;
            accent-color: #818cf8;
        }

        .ann-tool-label {
            font-size: 12px;
            color: rgba(255,255,255,0.4);
            padding: 0 4px;
        }

        /* -- Main layout -- */
        .ann-main {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        /* -- Sidebar -- */
        .ann-sidebar {
            width: 180px;
            background: #1e1e2e;
            border-right: 1px solid rgba(255,255,255,0.07);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .ann-sidebar-header {
            padding: 12px 14px 8px;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            flex-shrink: 0;
        }

        .ann-thumb-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 12px 12px;
            flex: 1;
        }

        .ann-thumb-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
            position: relative;
        }
        .ann-thumb-item:hover { border-color: rgba(99,102,241,0.5); }
        .ann-thumb-item.active { border-color: #818cf8; }

        .ann-thumb-canvas {
            width: 100%;
            display: block;
            background: #fff;
        }

        .ann-thumb-num {
            position: absolute;
            bottom: 4px;
            right: 6px;
            font-size: 10px;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        /* -- Viewer -- */
        .ann-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            padding: 24px;
            background: #2a2a3e;
            position: relative;
        }

        .ann-canvas-wrap {
            position: relative;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
            cursor: crosshair;
        }

        #ann-pdf-canvas {
            display: block;
            background: white;
        }

        #ann-draw-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .ann-page-nav {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 16px;
            background: rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 8px 16px;
            flex-shrink: 0;
        }

        .ann-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            background: transparent;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .ann-nav-btn:hover:not(:disabled) { background: rgba(255,255,255,0.1); color: white; }
        .ann-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .ann-page-info {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
        }

        /* -- No file state -- */
        .ann-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.35);
            gap: 16px;
        }

        .ann-empty-icon { font-size: 56px; opacity: 0.5; }
        .ann-empty-title { font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.5); }
        .ann-empty-sub { font-size: 14px; color: rgba(255,255,255,0.3); text-align: center; max-width: 320px; }

        /* -- Right panel -- */
        .ann-right-panel {
            width: 200px;
            background: #1e1e2e;
            border-left: 1px solid rgba(255,255,255,0.07);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .ann-panel-section {
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 12px 14px;
        }

        .ann-panel-title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 10px;
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .stamp-btn {
            padding: 6px 4px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.75);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            font-family: inherit;
        }
        .stamp-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .stamp-btn.approved { color: #34d399; border-color: rgba(52,211,153,0.3); }
        .stamp-btn.approved:hover { background: rgba(52,211,153,0.15); }
        .stamp-btn.rejected { color: #f87171; border-color: rgba(248,113,113,0.3); }
        .stamp-btn.rejected:hover { background: rgba(248,113,113,0.15); }
        .stamp-btn.confidential { color: #fb923c; border-color: rgba(251,146,60,0.3); }
        .stamp-btn.confidential:hover { background: rgba(251,146,60,0.15); }

        .custom-stamp-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .custom-stamp-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: all 0.15s;
        }
        .custom-stamp-item:hover { background: rgba(255,255,255,0.08); }

        .custom-stamp-preview {
            width: 32px;
            height: 20px;
            border-radius: 3px;
            object-fit: contain;
            background: white;
            flex-shrink: 0;
        }

        .custom-stamp-label {
            flex: 1;
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .custom-stamp-del {
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.3);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .custom-stamp-del:hover { color: #f87171; background: rgba(248,113,113,0.15); }

        .saved-sig-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .saved-sig-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: all 0.15s;
        }
        .saved-sig-item:hover { background: rgba(255,255,255,0.08); }

        .saved-sig-preview {
            width: 48px;
            height: 24px;
            object-fit: contain;
            background: transparent;
            flex-shrink: 0;
        }

        .saved-sig-del {
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.3);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
            margin-left: auto;
        }
        .saved-sig-del:hover { color: #f87171; background: rgba(248,113,113,0.15); }

        .ann-panel-btn {
            width: 100%;
            padding: 7px;
            border-radius: 7px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.65);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .ann-panel-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        /* -- Signature pad modal -- */
        .sig-pad-wrap {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--surface-3);
            margin-bottom: 12px;
        }

        #sig-canvas {
            display: block;
            width: 100%;
            height: 180px;
            cursor: crosshair;
            touch-action: none;
        }

        /* -- Color picker modal -- */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }

        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.15s;
        }
        .color-dot:hover { transform: scale(1.15); }
        .color-dot.selected { border-color: var(--ink); }

        /* -- Custom stamp text modal -- */
        .stamp-preview-box {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.08em;
            margin-bottom: 16px;
        }

        /* -- Movable objects on canvas -- */
        .ann-movable {
            position: absolute;
            cursor: move;
            user-select: none;
        }

        .ann-movable-text {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
            min-width: 30px;
            min-height: 20px;
        }

        .ann-movable .del-handle {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            font-size: 11px;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 2;
        }
        .ann-movable:hover .del-handle { display: flex; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .tool-cards { grid-template-columns: 1fr; }
            .ann-sidebar { display: none; }
            .ann-right-panel { width: 160px; }
        }
    </style>
</head>
<body>

<!-- ===== TOAST ===== -->
<div id="toast"></div>

<!-- ===== LOADING OVERLAY ===== -->
<div id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">Processing‚Ä¶</div>
</div>

<!-- ================================================================
     LANDING PAGE
================================================================ -->
<div id="landing" class="view active">
    <div class="landing-content">
        <div class="landing-badge">‚ú¶ Client-side ‚Ä¢ No uploads ‚Ä¢ Private</div>
        <h1 class="landing-title">PDF Tools <span>Professional</span></h1>
        <p class="landing-sub">Powerful PDF processing tools that run entirely in your browser. Your files never leave your device.</p>

        <div class="tool-cards">
            <div class="tool-card separator" onclick="openSeparator()">
                <div class="tool-icon">‚úÇÔ∏è</div>
                <div class="tool-card-title">PDF Separator</div>
                <div class="tool-card-desc">Split, reorder, and organize PDF pages into categorized documents.</div>
                <ul class="tool-card-features">
                    <li>Drag &amp; drop page reordering</li>
                    <li>Rotation &amp; flip controls</li>
                    <li>Category assignment</li>
                    <li>Download as organized ZIP</li>
                </ul>
                <button class="tool-card-btn">Open Separator ‚Üí</button>
            </div>

            <div class="tool-card annotator" onclick="openAnnotator()">
                <div class="tool-icon">‚úèÔ∏è</div>
                <div class="tool-card-title">PDF Annotator</div>
                <div class="tool-card-desc">Annotate PDFs with drawing tools, stamps, and digital signatures.</div>
                <ul class="tool-card-features">
                    <li>Draw, highlight, add text</li>
                    <li>Pre-made &amp; custom stamps</li>
                    <li>Digital signature pad</li>
                    <li>Download annotated PDF</li>
                </ul>
                <button class="tool-card-btn">Open Annotator ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<!-- ================================================================
     PDF SEPARATOR TOOL
================================================================ -->
<div id="separator" class="view">
    <!-- App bar -->
    <div class="app-bar">
        <button class="app-bar-back" onclick="goHome()">‚Üê</button>
        <span class="app-bar-title">PDF Separator</span>
        <div class="app-bar-spacer"></div>
        <input type="file" id="sep-file-input" accept=".pdf" style="display:none" onchange="handleSepFile(event)">
        <button class="btn btn-ghost" onclick="document.getElementById('sep-file-input').click()">üìÇ Load PDF</button>
    </div>

    <div class="sep-body" id="sep-body">
        <!-- Upload zone (shown when no PDF loaded) -->
        <div class="upload-zone-wrapper" id="sep-upload-wrapper">
            <div class="upload-zone" id="sep-upload-zone"
                 onclick="document.getElementById('sep-file-input').click()"
                 ondragover="sepDragOver(event)"
                 ondragleave="sepDragLeave(event)"
                 ondrop="sepDrop(event)">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-title">Drop your PDF here</div>
                <div class="upload-sub">or click to browse files</div>
                <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('sep-file-input').click()">Choose PDF File</button>
            </div>
        </div>

        <!-- Toolbar (shown after PDF loaded) -->
        <div class="sep-toolbar" id="sep-toolbar" style="display:none">
            <label>Bulk assign:</label>
            <select class="bulk-category-select" id="bulk-category">
                <option value="">‚Äî Category ‚Äî</option>
            </select>
            <button class="btn btn-ghost" id="bulk-assign-btn" onclick="bulkAssignCategory()">Apply to All</button>
            <div class="sep-toolbar-sep"></div>
            <div class="progress-bar-wrap">
                <div class="progress-bar" id="sep-progress-bar"></div>
            </div>
            <span class="progress-text" id="sep-progress-text"></span>
            <div class="sep-toolbar-sep"></div>
            <button class="btn btn-ghost" onclick="openAddCategoryModal()">+ Category</button>
            <button class="btn btn-primary" id="sep-download-btn" onclick="downloadSeparated()">‚¨á Download ZIP</button>
        </div>

        <!-- Grid -->
        <div class="sep-grid-wrapper" id="sep-grid-wrapper" style="display:none">
            <div class="sep-grid" id="sep-grid"></div>
        </div>
    </div>
</div>

<!-- ================================================================
     PDF ANNOTATOR TOOL
================================================================ -->
<div id="annotator" class="view">
    <!-- Menu bar -->
    <div class="ann-menubar">
        <button class="ann-back-btn" onclick="goHome()">‚Üê Home</button>
        <div class="ann-menubar-spacer"></div>
        <button class="ann-menu-btn" onclick="annOpenFile()">üìÇ Open</button>
        <button class="ann-menu-btn" onclick="annDownload()">‚¨á Download</button>
    </div>

    <!-- Toolbar -->
    <div class="ann-toolbar">
        <!-- Tools -->
        <button class="ann-tool-btn active" id="tool-select" onclick="setAnnTool('select')" title="Select / Move">‚¨Ü</button>
        <button class="ann-tool-btn" id="tool-draw" onclick="setAnnTool('draw')" title="Draw">‚úèÔ∏è</button>
        <button class="ann-tool-btn" id="tool-highlight" onclick="setAnnTool('highlight')" title="Highlight">üñä</button>
        <button class="ann-tool-btn" id="tool-text" onclick="setAnnTool('text')" title="Add Text">T</button>
        <button class="ann-tool-btn" id="tool-eraser" onclick="setAnnTool('eraser')" title="Eraser">‚¨ú</button>

        <div class="ann-toolbar-sep"></div>

        <!-- Color -->
        <span class="ann-tool-label">Color</span>
        <div class="ann-color-swatch" id="ann-color-swatch" style="background:#ef4444" onclick="openColorPicker()"></div>

        <div class="ann-toolbar-sep"></div>

        <!-- Size -->
        <span class="ann-tool-label">Size</span>
        <input type="range" class="ann-size-slider" id="ann-size-slider" min="1" max="40" value="4" oninput="annSizeChange(this.value)">
        <span class="ann-tool-label" id="ann-size-label" style="min-width:24px">4</span>

        <div class="ann-toolbar-sep"></div>

        <!-- Actions -->
        <button class="ann-tool-btn" onclick="annUndo()" title="Undo">‚Ü©</button>
        <button class="ann-tool-btn" onclick="annClearPage()" title="Clear Page">üóë</button>

        <input type="file" id="ann-file-input" accept=".pdf" style="display:none" onchange="handleAnnFile(event)">
    </div>

    <!-- Main -->
    <div class="ann-main">
        <!-- Sidebar -->
        <div class="ann-sidebar">
            <div class="ann-sidebar-header">Pages</div>
            <div class="ann-thumb-list" id="ann-thumb-list">
                <!-- thumbnails injected -->
            </div>
        </div>

        <!-- Viewer -->
        <div class="ann-viewer" id="ann-viewer">
            <div class="ann-empty" id="ann-empty">
                <div class="ann-empty-icon">üìã</div>
                <div class="ann-empty-title">No PDF loaded</div>
                <div class="ann-empty-sub">Open a PDF file to start annotating</div>
                <button class="btn btn-primary" onclick="annOpenFile()" style="margin-top:8px">üìÇ Open PDF</button>
            </div>
            <div id="ann-canvas-area" style="display:none; flex-direction:column; align-items:center; gap:16px">
                <div class="ann-canvas-wrap" id="ann-canvas-wrap">
                    <canvas id="ann-pdf-canvas"></canvas>
                    <canvas id="ann-draw-canvas"
                        onmousedown="annDrawStart(event)"
                        onmousemove="annDrawMove(event)"
                        onmouseup="annDrawEnd(event)"
                        onmouseleave="annDrawEnd(event)"
                        ontouchstart="annTouchStart(event)"
                        ontouchmove="annTouchMove(event)"
                        ontouchend="annDrawEnd(event)"></canvas>
                </div>
                <div class="ann-page-nav">
                    <button class="ann-nav-btn" id="ann-prev-btn" onclick="annPrevPage()">‚Äπ</button>
                    <span class="ann-page-info" id="ann-page-info">Page 1 of 1</span>
                    <button class="ann-nav-btn" id="ann-next-btn" onclick="annNextPage()">‚Ä∫</button>
                </div>
            </div>
        </div>

        <!-- Right panel -->
        <div class="ann-right-panel">
            <!-- Pre-made stamps -->
            <div class="ann-panel-section">
                <div class="ann-panel-title">Stamps</div>
                <div class="stamp-grid">
                    <button class="stamp-btn approved" onclick="placeStamp('APPROVED','#059669')">‚úì APPROVED</button>
                    <button class="stamp-btn rejected" onclick="placeStamp('REJECTED','#dc2626')">‚úó REJECTED</button>
                    <button class="stamp-btn confidential" onclick="placeStamp('CONFIDENTIAL','#d97706')">üîí CONFIDENTIAL</button>
                    <button class="stamp-btn" onclick="openCustomStampTextModal()" style="color:rgba(255,255,255,0.55)">+ Custom</button>
                </div>
            </div>

            <!-- Custom stamp library -->
            <div class="ann-panel-section">
                <div class="ann-panel-title">Stamp Library</div>
                <div class="custom-stamp-list" id="custom-stamp-list"></div>
                <button class="ann-panel-btn" onclick="openAddImageStampModal()">üñº Add Image Stamp</button>
            </div>

            <!-- Signatures -->
            <div class="ann-panel-section">
                <div class="ann-panel-title">Signatures</div>
                <div class="saved-sig-list" id="saved-sig-list"></div>
                <button class="ann-panel-btn" onclick="openSigPad()">‚úç Draw Signature</button>
            </div>
        </div>
    </div>
</div>

<!-- ================================================================
     MODALS
================================================================ -->

<!-- Add Category Modal (Separator) -->
<div class="modal-backdrop hidden" id="modal-add-cat">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Add Category</span>
            <button class="modal-close" onclick="closeModal('modal-add-cat')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Category name</label>
                <input class="form-control" id="new-cat-input" placeholder="e.g. Invoices" onkeydown="if(event.key==='Enter') confirmAddCategory()">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('modal-add-cat')">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAddCategory()">Add</button>
        </div>
    </div>
</div>

<!-- Color Picker Modal (Annotator) -->
<div class="modal-backdrop hidden" id="modal-color-picker">
    <div class="modal" style="max-width:320px">
        <div class="modal-header">
            <span class="modal-title">Pick Color</span>
            <button class="modal-close" onclick="closeModal('modal-color-picker')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="color-grid" id="color-grid"></div>
            <input type="color" class="form-control" id="custom-color-input" style="height:40px;padding:2px 6px" oninput="setAnnColor(this.value)">
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('modal-color-picker')">Done</button>
        </div>
    </div>
</div>

<!-- Signature Pad Modal -->
<div class="modal-backdrop hidden" id="modal-sig-pad">
    <div class="modal" style="max-width:540px">
        <div class="modal-header">
            <span class="modal-title">Draw Signature</span>
            <button class="modal-close" onclick="closeModal('modal-sig-pad')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="sig-pad-wrap">
                <canvas id="sig-canvas"
                    onmousedown="sigPadStart(event)"
                    onmousemove="sigPadMove(event)"
                    onmouseup="sigPadEnd(event)"
                    onmouseleave="sigPadEnd(event)"
                    ontouchstart="sigTouchStart(event)"
                    ontouchmove="sigTouchMove(event)"
                    ontouchend="sigPadEnd(event)"></canvas>
            </div>
            <button class="btn btn-ghost" style="width:100%" onclick="clearSigPad()">Clear</button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('modal-sig-pad')">Cancel</button>
            <button class="btn btn-ghost" onclick="saveSig()">Save to Library</button>
            <button class="btn btn-primary" onclick="placeSigNow()">Place on Page</button>
        </div>
    </div>
</div>

<!-- Custom Stamp Text Modal -->
<div class="modal-backdrop hidden" id="modal-custom-stamp-text">
    <div class="modal" style="max-width:400px">
        <div class="modal-header">
            <span class="modal-title">Create Text Stamp</span>
            <button class="modal-close" onclick="closeModal('modal-custom-stamp-text')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Stamp text</label>
                <input class="form-control" id="custom-stamp-text-input" placeholder="e.g. DRAFT" maxlength="30">
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <input type="color" class="form-control" id="custom-stamp-color" value="#4f46e5" style="height:40px;padding:2px 6px">
            </div>
            <div class="stamp-preview-box" id="custom-stamp-preview" style="border-color:#4f46e5;color:#4f46e5">PREVIEW</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('modal-custom-stamp-text')">Cancel</button>
            <button class="btn btn-ghost" onclick="saveCustomTextStamp()">Save to Library</button>
            <button class="btn btn-primary" onclick="placeCustomTextStampNow()">Place on Page</button>
        </div>
    </div>
</div>

<!-- Add Text Modal (Annotator) -->
<div class="modal-backdrop hidden" id="modal-add-text">
    <div class="modal" style="max-width:400px">
        <div class="modal-header">
            <span class="modal-title">Add Text</span>
            <button class="modal-close" onclick="closeModal('modal-add-text')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Text</label>
                <input class="form-control" id="add-text-input" placeholder="Enter text‚Ä¶" onkeydown="if(event.key==='Enter') confirmAddText()">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('modal-add-text')">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAddText()">Place</button>
        </div>
    </div>
</div>

<!-- Add Image Stamp Modal -->
<div class="modal-backdrop hidden" id="modal-image-stamp">
    <div class="modal" style="max-width:400px">
        <div class="modal-header">
            <span class="modal-title">Add Image Stamp</span>
            <button class="modal-close" onclick="closeModal('modal-image-stamp')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Image file (PNG/JPG/SVG)</label>
                <input type="file" class="form-control" id="stamp-img-input" accept="image/*">
            </div>
            <div class="form-group">
                <label class="form-label">Label</label>
                <input class="form-control" id="stamp-img-label" placeholder="Stamp name">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('modal-image-stamp')">Cancel</button>
            <button class="btn btn-primary" onclick="saveImageStamp()">Save to Library</button>
        </div>
    </div>
</div>

<script>
// =====================================================================
// GLOBAL STATE & UTILITIES
// =====================================================================
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

function showView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function goHome() { showView('landing'); }
function openSeparator() { showView('separator'); }
function openAnnotator() { showView('annotator'); }

function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

function openModal(id) {
    document.getElementById(id).classList.remove('hidden');
}

let toastTimer;
function showToast(msg, duration = 3000) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), duration);
}

function showLoading(msg = 'Processing‚Ä¶') {
    document.getElementById('loading-text').textContent = msg;
    document.getElementById('loading-overlay').classList.add('show');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.remove('show');
}

// =====================================================================
// PDF SEPARATOR
// =====================================================================
let sepPages = [];      // { pageIndex, rotation, flipH, flipV, category } ‚Äî all pages share sepPdfBytes
let sepPdfBytes = null; // shared Uint8Array for the loaded PDF
let sepPdfDoc = null;   // pdf.js doc
let sepCategories = ['Uncategorized'];
let sepDragSrcIdx = null;

function sepDragOver(e) { e.preventDefault(); document.getElementById('sep-upload-zone').classList.add('drag-over'); }
function sepDragLeave() { document.getElementById('sep-upload-zone').classList.remove('drag-over'); }

function sepDrop(e) {
    e.preventDefault();
    sepDragLeave();
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') {
        loadSepFile(file);
    } else {
        showToast('Please drop a PDF file.');
    }
}

function handleSepFile(e) {
    const file = e.target.files[0];
    if (file) loadSepFile(file);
    e.target.value = '';
}

async function loadSepFile(file) {
    showLoading('Loading PDF‚Ä¶');
    try {
        const arrayBuffer = await file.arrayBuffer();
        sepPdfBytes = new Uint8Array(arrayBuffer);
        sepPdfDoc = await pdfjsLib.getDocument({ data: sepPdfBytes }).promise;

        sepPages = [];
        for (let i = 0; i < sepPdfDoc.numPages; i++) {
            sepPages.push({ pageIndex: i, rotation: 0, flipH: false, flipV: false, category: 'Uncategorized' });
        }

        updateCategorySelects();
        renderSepGrid();
        updateSepProgress();
        showSepWorkspace();
    } catch (err) {
        showToast('Failed to load PDF: ' + err.message);
    } finally {
        hideLoading();
    }
}

function showSepWorkspace() {
    document.getElementById('sep-upload-wrapper').style.display = 'none';
    document.getElementById('sep-toolbar').style.display = 'flex';
    document.getElementById('sep-grid-wrapper').style.display = 'block';
}

async function renderSepGrid() {
    const grid = document.getElementById('sep-grid');
    grid.innerHTML = '';
    for (let i = 0; i < sepPages.length; i++) {
        const card = await createPageCard(i);
        grid.appendChild(card);
    }
}

async function createPageCard(idx) {
    const p = sepPages[idx];
    const card = document.createElement('div');
    card.className = 'page-card';
    card.draggable = true;
    card.dataset.idx = idx;

    card.ondragstart = (e) => { sepDragSrcIdx = idx; card.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; };
    card.ondragend = () => card.classList.remove('dragging');
    card.ondragover = (e) => { e.preventDefault(); card.classList.add('drag-over-card'); };
    card.ondragleave = () => card.classList.remove('drag-over-card');
    card.ondrop = (e) => { e.preventDefault(); card.classList.remove('drag-over-card'); sepDropPage(idx); };

    // Thumbnail
    const thumbDiv = document.createElement('div');
    thumbDiv.className = 'page-thumb';

    const canvas = document.createElement('canvas');
    try {
        const pdfPage = await sepPdfDoc.getPage(p.pageIndex + 1);
        const vp = pdfPage.getViewport({ scale: 1, rotation: p.rotation });
        const scale = 200 / Math.max(vp.width, vp.height);
        const viewport = pdfPage.getViewport({ scale, rotation: p.rotation });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');

        if (p.flipH || p.flipV) {
            ctx.save();
            ctx.translate(p.flipH ? viewport.width : 0, p.flipV ? viewport.height : 0);
            ctx.scale(p.flipH ? -1 : 1, p.flipV ? -1 : 1);
        }

        await pdfPage.render({ canvasContext: ctx, viewport }).promise;

        if (p.flipH || p.flipV) ctx.restore();
    } catch (e) {
        const ph = document.createElement('div');
        ph.className = 'page-thumb-placeholder';
        ph.textContent = 'üìÑ';
        thumbDiv.appendChild(ph);
    }

    thumbDiv.appendChild(canvas);

    // Action buttons
    const actions = document.createElement('div');
    actions.className = 'page-actions';

    const makeActionBtn = (icon, title, fn) => {
        const b = document.createElement('button');
        b.className = 'page-action-btn';
        b.textContent = icon;
        b.title = title;
        b.onclick = (e) => { e.stopPropagation(); fn(); };
        return b;
    };

    actions.appendChild(makeActionBtn('‚Ü∫', 'Rotate Left', () => rotatePage(idx, -90)));
    actions.appendChild(makeActionBtn('‚Üª', 'Rotate Right', () => rotatePage(idx, 90)));
    actions.appendChild(makeActionBtn('‚Üî', 'Flip Horizontal', () => flipPage(idx, 'H')));
    actions.appendChild(makeActionBtn('‚Üï', 'Flip Vertical', () => flipPage(idx, 'V')));
    actions.appendChild(makeActionBtn('‚úï', 'Remove', () => removePage(idx)));

    thumbDiv.appendChild(actions);
    card.appendChild(thumbDiv);

    // Info area
    const info = document.createElement('div');
    info.className = 'page-info';

    const numRow = document.createElement('div');
    numRow.className = 'page-num';

    const numSpan = document.createElement('span');
    numSpan.textContent = `Page ${idx + 1}`;
    numRow.appendChild(numSpan);

    const flipInd = document.createElement('span');
    flipInd.className = 'flip-indicator';
    flipInd.textContent = 'flipped';
    if (p.flipH || p.flipV) flipInd.style.display = 'inline';
    numRow.appendChild(flipInd);
    info.appendChild(numRow);

    const sel = document.createElement('select');
    sel.className = 'page-category-select';
    sepCategories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        if (cat === p.category) opt.selected = true;
        sel.appendChild(opt);
    });
    sel.onchange = () => { sepPages[idx].category = sel.value; updateSepProgress(); };
    info.appendChild(sel);
    card.appendChild(info);

    return card;
}

function sepDropPage(targetIdx) {
    if (sepDragSrcIdx === null || sepDragSrcIdx === targetIdx) return;
    const moved = sepPages.splice(sepDragSrcIdx, 1)[0];
    sepPages.splice(targetIdx, 0, moved);
    sepDragSrcIdx = null;
    renderSepGrid();
    updateSepProgress();
}

async function rotatePage(idx, deg) {
    sepPages[idx].rotation = ((sepPages[idx].rotation + deg) + 360) % 360;
    const grid = document.getElementById('sep-grid');
    const oldCard = grid.children[idx];
    const newCard = await createPageCard(idx);
    grid.replaceChild(newCard, oldCard);
}

async function flipPage(idx, axis) {
    if (axis === 'H') sepPages[idx].flipH = !sepPages[idx].flipH;
    else sepPages[idx].flipV = !sepPages[idx].flipV;
    const grid = document.getElementById('sep-grid');
    const oldCard = grid.children[idx];
    const newCard = await createPageCard(idx);
    grid.replaceChild(newCard, oldCard);
}

async function removePage(idx) {
    sepPages.splice(idx, 1);
    await renderSepGrid();
    updateSepProgress();
}

function updateCategorySelects() {
    const bulk = document.getElementById('bulk-category');
    bulk.innerHTML = '<option value="">‚Äî Category ‚Äî</option>';
    sepCategories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        bulk.appendChild(opt);
    });
}

function bulkAssignCategory() {
    const cat = document.getElementById('bulk-category').value;
    if (!cat) { showToast('Select a category first.'); return; }
    sepPages.forEach(p => p.category = cat);
    renderSepGrid();
    updateSepProgress();
    showToast(`All pages assigned to "${cat}"`);
}

function openAddCategoryModal() {
    document.getElementById('new-cat-input').value = '';
    openModal('modal-add-cat');
    setTimeout(() => document.getElementById('new-cat-input').focus(), 100);
}

function confirmAddCategory() {
    const name = document.getElementById('new-cat-input').value.trim();
    if (!name) return;
    if (sepCategories.includes(name)) { showToast('Category already exists.'); return; }
    sepCategories.push(name);
    updateCategorySelects();
    renderSepGrid();
    closeModal('modal-add-cat');
    showToast(`Category "${name}" added`);
}

function updateSepProgress() {
    const total = sepPages.length;
    const assigned = sepPages.filter(p => p.category !== 'Uncategorized').length;
    const pct = total ? Math.round((assigned / total) * 100) : 0;
    document.getElementById('sep-progress-bar').style.width = pct + '%';
    document.getElementById('sep-progress-text').textContent = `${assigned}/${total} categorized`;
}

async function downloadSeparated() {
    if (!sepPages.length) { showToast('No pages to download.'); return; }
    showLoading('Building ZIP‚Ä¶');
    try {
        const zip = new JSZip();
        const byCategory = {};
        sepPages.forEach(p => {
            if (!byCategory[p.category]) byCategory[p.category] = [];
            byCategory[p.category].push(p);
        });

        for (const [cat, pages] of Object.entries(byCategory)) {
            const pdfDoc = await PDFLib.PDFDocument.create();
            const srcDoc = await PDFLib.PDFDocument.load(sepPdfBytes);
            for (const p of pages) {
                const [copiedPage] = await pdfDoc.copyPages(srcDoc, [p.pageIndex]);
                const { width, height } = copiedPage.getSize();

                let rotation = p.rotation;
                copiedPage.setRotation(PDFLib.degrees(rotation));

                if (p.flipH || p.flipV) {
                    const sx = p.flipH ? -1 : 1;
                    const sy = p.flipV ? -1 : 1;
                    const tx = p.flipH ? width : 0;
                    const ty = p.flipV ? height : 0;
                    copiedPage.setMediaBox(0, 0, width, height);
                    const ops = copiedPage.node.get(PDFLib.PDFName.of('Contents'));
                    const existing = ops ? ops.toString() : '';
                    const transform = `q ${sx} 0 0 ${sy} ${tx} ${ty} cm\n${existing}\nQ`;
                    copiedPage.setContents(pdfDoc.context.flateStream(transform));
                }

                pdfDoc.addPage(copiedPage);
            }
            const pdfBytes = await pdfDoc.save();
            const safeCat = cat.replace(/[^a-z0-9_\-]/gi, '_');
            zip.file(`${safeCat}.pdf`, pdfBytes);
        }

        const zipBlob = await zip.generateAsync({ type: 'blob' });
        downloadBlob(zipBlob, 'separated_pdfs.zip');
        showToast('ZIP downloaded!');
    } catch (err) {
        showToast('Download failed: ' + err.message);
    } finally {
        hideLoading();
    }
}

// =====================================================================
// PDF ANNOTATOR
// =====================================================================
let annPdfDoc = null;
let annPdfBytes = null;
let annCurrentPage = 1;
let annTotalPages = 0;
let annTool = 'select';
let annColor = '#ef4444';
let annBrushSize = 4;

// Per-page: { paths: [], objects: [] }
// paths: drawn strokes, objects: movable items
let annPageData = {};

let annDrawing = false;
let annCurrentPath = null;

function getPageData(pageNum) {
    if (!annPageData[pageNum]) annPageData[pageNum] = { paths: [], objects: [] };
    return annPageData[pageNum];
}

function annOpenFile() { document.getElementById('ann-file-input').click(); }

async function handleAnnFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    e.target.value = '';
    showLoading('Loading PDF‚Ä¶');
    try {
        annPdfBytes = await file.arrayBuffer();
        annPdfDoc = await pdfjsLib.getDocument({ data: annPdfBytes.slice(0) }).promise;
        annTotalPages = annPdfDoc.numPages;
        annCurrentPage = 1;
        annPageData = {};
        await renderAnnThumbs();
        await renderAnnPage(annCurrentPage);
        document.getElementById('ann-empty').style.display = 'none';
        document.getElementById('ann-canvas-area').style.display = 'flex';
        showToast(`Loaded ${annTotalPages} page(s)`);
    } catch (err) {
        showToast('Failed to load PDF: ' + err.message);
    } finally {
        hideLoading();
    }
}

async function renderAnnPage(pageNum) {
    const pdfPage = await annPdfDoc.getPage(pageNum);
    const viewer = document.getElementById('ann-viewer');
    const availW = viewer.clientWidth - 64;
    const availH = viewer.clientHeight - 120;

    const vp0 = pdfPage.getViewport({ scale: 1 });
    const scale = Math.min(availW / vp0.width, availH / vp0.height, 2.5);
    const viewport = pdfPage.getViewport({ scale });

    const pdfCanvas = document.getElementById('ann-pdf-canvas');
    const drawCanvas = document.getElementById('ann-draw-canvas');
    pdfCanvas.width = viewport.width;
    pdfCanvas.height = viewport.height;
    drawCanvas.width = viewport.width;
    drawCanvas.height = viewport.height;

    const ctx = pdfCanvas.getContext('2d');
    await pdfPage.render({ canvasContext: ctx, viewport }).promise;

    restoreDrawings(pageNum);
    updateAnnPageInfo();
    updateAnnThumbs();
}

function restoreDrawings(pageNum) {
    const drawCanvas = document.getElementById('ann-draw-canvas');
    const ctx = drawCanvas.getContext('2d');
    ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    const data = getPageData(pageNum);
    data.paths.forEach(path => drawPath(ctx, path));
    // Restore movable objects
    document.querySelectorAll('.ann-movable').forEach(e => e.remove());
    data.objects.forEach(obj => createMovableElement(obj));
}

function drawPath(ctx, path) {
    if (!path.points || path.points.length < 2) return;
    ctx.save();
    ctx.globalAlpha = path.alpha || 1;
    ctx.strokeStyle = path.color;
    ctx.lineWidth = path.size;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    if (path.composite) ctx.globalCompositeOperation = path.composite;
    ctx.beginPath();
    ctx.moveTo(path.points[0].x, path.points[0].y);
    for (let i = 1; i < path.points.length; i++) {
        ctx.lineTo(path.points[i].x, path.points[i].y);
    }
    ctx.stroke();
    ctx.restore();
}

function updateAnnPageInfo() {
    document.getElementById('ann-page-info').textContent = `Page ${annCurrentPage} of ${annTotalPages}`;
    document.getElementById('ann-prev-btn').disabled = annCurrentPage <= 1;
    document.getElementById('ann-next-btn').disabled = annCurrentPage >= annTotalPages;
}

async function renderAnnThumbs() {
    const list = document.getElementById('ann-thumb-list');
    list.innerHTML = '';
    for (let i = 1; i <= annTotalPages; i++) {
        const item = document.createElement('div');
        item.className = 'ann-thumb-item' + (i === annCurrentPage ? ' active' : '');
        item.dataset.page = i;
        item.onclick = () => annGoToPage(i);

        const pdfPage = await annPdfDoc.getPage(i);
        const vp = pdfPage.getViewport({ scale: 0.3 });
        const c = document.createElement('canvas');
        c.className = 'ann-thumb-canvas';
        c.width = vp.width;
        c.height = vp.height;
        await pdfPage.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;

        const num = document.createElement('span');
        num.className = 'ann-thumb-num';
        num.textContent = i;

        item.appendChild(c);
        item.appendChild(num);
        list.appendChild(item);
    }
}

function updateAnnThumbs() {
    document.querySelectorAll('.ann-thumb-item').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.page) === annCurrentPage);
    });
}

async function annGoToPage(pageNum) {
    if (pageNum < 1 || pageNum > annTotalPages) return;
    annCurrentPage = pageNum;
    await renderAnnPage(pageNum);
}

async function annPrevPage() { await annGoToPage(annCurrentPage - 1); }
async function annNextPage() { await annGoToPage(annCurrentPage + 1); }

// --- Drawing ---
function setAnnTool(tool) {
    annTool = tool;
    document.querySelectorAll('.ann-tool-btn').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById('tool-' + tool);
    if (btn) btn.classList.add('active');

    const drawCanvas = document.getElementById('ann-draw-canvas');
    if (tool === 'select') drawCanvas.style.cursor = 'default';
    else if (tool === 'eraser') drawCanvas.style.cursor = 'cell';
    else drawCanvas.style.cursor = 'crosshair';
}

function getCanvasPos(canvas, e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

function annDrawStart(e) {
    if (annTool === 'select' || !annPdfDoc) return;
    annDrawing = true;

    const drawCanvas = document.getElementById('ann-draw-canvas');
    const pos = getCanvasPos(drawCanvas, e);

    if (annTool === 'text') {
        annDrawing = false;
        placeTextObject(pos.x, pos.y);
        return;
    }

    annCurrentPath = {
        color: annTool === 'eraser' ? '#ffffff' : (annTool === 'highlight' ? annColor : annColor),
        size: annTool === 'highlight' ? annBrushSize * 4 : (annTool === 'eraser' ? annBrushSize * 3 : annBrushSize),
        alpha: annTool === 'highlight' ? 0.4 : 1,
        composite: annTool === 'eraser' ? 'destination-out' : 'source-over',
        points: [pos]
    };
}

function annDrawMove(e) {
    if (!annDrawing || !annCurrentPath) return;
    const drawCanvas = document.getElementById('ann-draw-canvas');
    const pos = getCanvasPos(drawCanvas, e);
    annCurrentPath.points.push(pos);

    const ctx = drawCanvas.getContext('2d');
    ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    const data = getPageData(annCurrentPage);
    data.paths.forEach(path => drawPath(ctx, path));
    drawPath(ctx, annCurrentPath);
}

function annDrawEnd() {
    if (!annDrawing || !annCurrentPath) { annDrawing = false; return; }
    annDrawing = false;
    if (annCurrentPath.points.length >= 2) {
        getPageData(annCurrentPage).paths.push(annCurrentPath);
    }
    annCurrentPath = null;
}

function annTouchStart(e) { e.preventDefault(); if (e.touches.length) annDrawStart(e.touches[0]); }
function annTouchMove(e) { e.preventDefault(); if (e.touches.length) annDrawMove(e.touches[0]); }

function annUndo() {
    const data = getPageData(annCurrentPage);
    if (data.paths.length) {
        data.paths.pop();
        restoreDrawings(annCurrentPage);
        showToast('Undo');
    } else {
        showToast('Nothing to undo');
    }
}

function annClearPage() {
    annPageData[annCurrentPage] = { paths: [], objects: [] };
    document.querySelectorAll('.ann-movable').forEach(e => e.remove());
    const drawCanvas = document.getElementById('ann-draw-canvas');
    drawCanvas.getContext('2d').clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    showToast('Page cleared');
}

// --- Color ---
const PRESET_COLORS = ['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#ec4899',
    '#dc2626','#ea580c','#ca8a04','#16a34a','#0891b2','#2563eb','#7c3aed','#db2777',
    '#fca5a5','#fdba74','#fde047','#86efac','#67e8f9','#93c5fd','#c4b5fd','#f9a8d4',
    '#000000','#374151','#6b7280','#9ca3af','#d1d5db','#f3f4f6','#ffffff','#78350f'];

function buildColorGrid() {
    const grid = document.getElementById('color-grid');
    grid.innerHTML = '';
    PRESET_COLORS.forEach(c => {
        const dot = document.createElement('div');
        dot.className = 'color-dot' + (c === annColor ? ' selected' : '');
        dot.style.background = c;
        dot.onclick = () => { setAnnColor(c); closeModal('modal-color-picker'); };
        grid.appendChild(dot);
    });
    document.getElementById('custom-color-input').value = annColor;
}

function openColorPicker() { buildColorGrid(); openModal('modal-color-picker'); }

function setAnnColor(color) {
    annColor = color;
    document.getElementById('ann-color-swatch').style.background = color;
    document.querySelectorAll('.color-dot').forEach(d => {
        d.classList.toggle('selected', d.style.background === color);
    });
}

function annSizeChange(val) {
    annBrushSize = parseInt(val);
    document.getElementById('ann-size-label').textContent = val;
}

// --- Stamps ---
function placeStamp(text, color) {
    if (!annPdfDoc) { showToast('Open a PDF first.'); return; }
    const drawCanvas = document.getElementById('ann-draw-canvas');
    const x = drawCanvas.width / 2 - 60;
    const y = drawCanvas.height / 2 - 20;
    placeTextStampAt(text, color, x, y);
}

function placeTextStampAt(text, color, x, y) {
    const obj = { type: 'stamp', text, color, x, y };
    getPageData(annCurrentPage).objects.push(obj);
    createMovableElement(obj);
}

let _pendingTextPos = null;

function placeTextObject(x, y) {
    _pendingTextPos = { x, y };
    document.getElementById('add-text-input').value = '';
    openModal('modal-add-text');
    setTimeout(() => document.getElementById('add-text-input').focus(), 100);
}

function confirmAddText() {
    const text = document.getElementById('add-text-input').value.trim();
    closeModal('modal-add-text');
    if (!text || !_pendingTextPos) return;
    const obj = { type: 'text', text, color: annColor, size: annBrushSize * 3 + 8, x: _pendingTextPos.x, y: _pendingTextPos.y };
    getPageData(annCurrentPage).objects.push(obj);
    createMovableElement(obj);
    _pendingTextPos = null;
}

function createMovableElement(obj) {
    const wrap = document.getElementById('ann-canvas-wrap');
    const el = document.createElement('div');
    el.className = 'ann-movable';
    el.style.left = obj.x + 'px';
    el.style.top = obj.y + 'px';

    if (obj.type === 'stamp') {
        el.style.border = `2px solid ${obj.color}`;
        el.style.color = obj.color;
        el.style.padding = '4px 12px';
        el.style.borderRadius = '4px';
        el.style.fontSize = '16px';
        el.style.fontWeight = '700';
        el.style.letterSpacing = '0.08em';
        el.style.background = `${obj.color}18`;
        el.style.fontFamily = 'DM Sans, sans-serif';
        el.textContent = obj.text;
    } else if (obj.type === 'text') {
        el.className += ' ann-movable-text';
        el.style.color = obj.color;
        el.style.fontSize = (obj.size || 16) + 'px';
        el.textContent = obj.text;
    } else if (obj.type === 'image' || obj.type === 'signature') {
        const img = document.createElement('img');
        img.src = obj.src;
        img.style.width = (obj.width || 100) + 'px';
        img.style.height = 'auto';
        img.style.display = 'block';
        el.appendChild(img);
    }

    // Delete handle
    const del = document.createElement('button');
    del.className = 'del-handle';
    del.textContent = '‚úï';
    del.onclick = (e) => {
        e.stopPropagation();
        const data = getPageData(annCurrentPage);
        const objIdx = data.objects.indexOf(obj);
        if (objIdx > -1) data.objects.splice(objIdx, 1);
        el.remove();
    };
    el.appendChild(del);

    // Drag to move
    makeDraggable(el, obj);
    wrap.appendChild(el);
}

function makeDraggable(el, obj) {
    let startX, startY, startLeft, startTop;

    function onDown(e) {
        if (e.target.classList.contains('del-handle')) return;
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        startX = clientX;
        startY = clientY;
        startLeft = parseInt(el.style.left) || 0;
        startTop = parseInt(el.style.top) || 0;
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', onUp);
    }

    function onMove(e) {
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - startX;
        const dy = clientY - startY;
        obj.x = startLeft + dx;
        obj.y = startTop + dy;
        el.style.left = obj.x + 'px';
        el.style.top = obj.y + 'px';
    }

    function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onUp);
    }

    el.addEventListener('mousedown', onDown);
    el.addEventListener('touchstart', onDown, { passive: false });
}

// --- Custom stamps ---
let customStamps = JSON.parse(localStorage.getItem('pdftools_stamps') || '[]');

function saveCustomStampsToStorage() {
    localStorage.setItem('pdftools_stamps', JSON.stringify(customStamps));
}

function renderCustomStampList() {
    const list = document.getElementById('custom-stamp-list');
    list.innerHTML = '';
    customStamps.forEach((stamp, i) => {
        const item = document.createElement('div');
        item.className = 'custom-stamp-item';

        if (stamp.type === 'image') {
            const img = document.createElement('img');
            img.src = stamp.src;
            img.className = 'custom-stamp-preview';
            item.appendChild(img);
        } else {
            const prev = document.createElement('div');
            prev.className = 'custom-stamp-preview';
            prev.style.cssText = `display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:${stamp.color};border:1px solid ${stamp.color};`;
            prev.textContent = stamp.text.substring(0, 8);
            item.appendChild(prev);
        }

        const label = document.createElement('span');
        label.className = 'custom-stamp-label';
        label.textContent = stamp.label || stamp.text;
        item.appendChild(label);

        const del = document.createElement('button');
        del.className = 'custom-stamp-del';
        del.textContent = '‚úï';
        del.onclick = (e) => { e.stopPropagation(); customStamps.splice(i, 1); saveCustomStampsToStorage(); renderCustomStampList(); };
        item.appendChild(del);

        item.onclick = () => {
            if (!annPdfDoc) { showToast('Open a PDF first.'); return; }
            if (stamp.type === 'image') placeImageAt(stamp.src, 120);
            else placeTextStampAt(stamp.text, stamp.color, 100, 100);
        };

        list.appendChild(item);
    });
}

renderCustomStampList();

function openCustomStampTextModal() {
    document.getElementById('custom-stamp-text-input').value = '';
    document.getElementById('custom-stamp-color').value = '#4f46e5';
    updateCustomStampPreview();
    openModal('modal-custom-stamp-text');
    document.getElementById('custom-stamp-text-input').oninput = updateCustomStampPreview;
    document.getElementById('custom-stamp-color').oninput = updateCustomStampPreview;
}

function updateCustomStampPreview() {
    const text = document.getElementById('custom-stamp-text-input').value || 'PREVIEW';
    const color = document.getElementById('custom-stamp-color').value;
    const prev = document.getElementById('custom-stamp-preview');
    prev.textContent = text.toUpperCase();
    prev.style.borderColor = color;
    prev.style.color = color;
}

function saveCustomTextStamp() {
    const text = document.getElementById('custom-stamp-text-input').value.trim().toUpperCase();
    const color = document.getElementById('custom-stamp-color').value;
    if (!text) { showToast('Enter stamp text.'); return; }
    customStamps.push({ type: 'text', text, color, label: text });
    saveCustomStampsToStorage();
    renderCustomStampList();
    closeModal('modal-custom-stamp-text');
    showToast('Stamp saved to library');
}

function placeCustomTextStampNow() {
    const text = document.getElementById('custom-stamp-text-input').value.trim().toUpperCase();
    const color = document.getElementById('custom-stamp-color').value;
    if (!text) { showToast('Enter stamp text.'); return; }
    if (!annPdfDoc) { showToast('Open a PDF first.'); return; }
    closeModal('modal-custom-stamp-text');
    placeTextStampAt(text, color, 100, 100);
}

function openAddImageStampModal() {
    document.getElementById('stamp-img-input').value = '';
    document.getElementById('stamp-img-label').value = '';
    openModal('modal-image-stamp');
}

async function saveImageStamp() {
    const file = document.getElementById('stamp-img-input').files[0];
    const label = document.getElementById('stamp-img-label').value.trim() || 'Image Stamp';
    if (!file) { showToast('Choose an image file.'); return; }
    const src = await fileToDataURL(file);
    customStamps.push({ type: 'image', src, label });
    saveCustomStampsToStorage();
    renderCustomStampList();
    closeModal('modal-image-stamp');
    showToast('Image stamp saved');
}

// --- Signatures ---
let savedSignatures = JSON.parse(localStorage.getItem('pdftools_signatures') || '[]');

function saveSigsToStorage() {
    localStorage.setItem('pdftools_signatures', JSON.stringify(savedSignatures));
}

function renderSavedSigs() {
    const list = document.getElementById('saved-sig-list');
    list.innerHTML = '';
    savedSignatures.forEach((sig, i) => {
        const item = document.createElement('div');
        item.className = 'saved-sig-item';

        const img = document.createElement('img');
        img.src = sig;
        img.className = 'saved-sig-preview';
        item.appendChild(img);

        const del = document.createElement('button');
        del.className = 'saved-sig-del';
        del.textContent = '‚úï';
        del.onclick = (e) => { e.stopPropagation(); savedSignatures.splice(i, 1); saveSigsToStorage(); renderSavedSigs(); };
        item.appendChild(del);

        item.onclick = () => {
            if (!annPdfDoc) { showToast('Open a PDF first.'); return; }
            placeImageAt(sig, 140, true);
        };

        list.appendChild(item);
    });
}

renderSavedSigs();

// Signature pad
let sigDrawing = false;
let sigLastX, sigLastY;

function openSigPad() {
    openModal('modal-sig-pad');
    const canvas = document.getElementById('sig-canvas');
    canvas.width = canvas.offsetWidth || 480;
    canvas.height = 180;
    clearSigPad();
}

function clearSigPad() {
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function getSigPos(e) {
    const canvas = document.getElementById('sig-canvas');
    const rect = canvas.getBoundingClientRect();
    return {
        x: (e.clientX - rect.left) * (canvas.width / rect.width),
        y: (e.clientY - rect.top) * (canvas.height / rect.height)
    };
}

function sigPadStart(e) {
    sigDrawing = true;
    const pos = getSigPos(e);
    sigLastX = pos.x; sigLastY = pos.y;
}

function sigPadMove(e) {
    if (!sigDrawing) return;
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    const pos = getSigPos(e);
    ctx.beginPath();
    ctx.moveTo(sigLastX, sigLastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.strokeStyle = '#1a1a2e';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.stroke();
    sigLastX = pos.x; sigLastY = pos.y;
}

function sigPadEnd() { sigDrawing = false; }

function sigTouchStart(e) { e.preventDefault(); sigPadStart(e.touches[0]); }
function sigTouchMove(e) { e.preventDefault(); sigPadMove(e.touches[0]); }

function getSigDataURL() {
    const canvas = document.getElementById('sig-canvas');
    return canvas.toDataURL('image/png');
}

function saveSig() {
    const dataURL = getSigDataURL();
    savedSignatures.push(dataURL);
    saveSigsToStorage();
    renderSavedSigs();
    closeModal('modal-sig-pad');
    showToast('Signature saved to library');
}

function placeSigNow() {
    if (!annPdfDoc) { showToast('Open a PDF first.'); return; }
    const src = getSigDataURL();
    closeModal('modal-sig-pad');
    placeImageAt(src, 140, true);
}

function placeImageAt(src, width, isSignature = false) {
    const obj = { type: isSignature ? 'signature' : 'image', src, width, x: 100, y: 100 };
    getPageData(annCurrentPage).objects.push(obj);
    createMovableElement(obj);
}

// --- Download annotated PDF ---
async function annDownload() {
    if (!annPdfDoc || !annPdfBytes) { showToast('No PDF loaded.'); return; }
    showLoading('Generating annotated PDF‚Ä¶');
    try {
        const pdfDoc = await PDFLib.PDFDocument.load(annPdfBytes);
        const pages = pdfDoc.getPages();

        for (let pageNum = 1; pageNum <= annTotalPages; pageNum++) {
            const page = pages[pageNum - 1];
            const { width: pdfW, height: pdfH } = page.getSize();

            // Get rendered canvas dimensions for this page
            const pdfPageObj = await annPdfDoc.getPage(pageNum);
            const viewer = document.getElementById('ann-viewer');
            const availW = viewer.clientWidth - 64;
            const availH = viewer.clientHeight - 120;
            const vp0 = pdfPageObj.getViewport({ scale: 1 });
            const scale = Math.min(availW / vp0.width, availH / vp0.height, 2.5);
            const viewport = pdfPageObj.getViewport({ scale });
            const canvasW = viewport.width;
            const canvasH = viewport.height;

            const data = annPageData[pageNum];
            if (!data) continue;

            // Composite drawings onto an offscreen canvas
            if (data.paths.length > 0) {
                const offCanvas = document.createElement('canvas');
                offCanvas.width = canvasW;
                offCanvas.height = canvasH;
                const offCtx = offCanvas.getContext('2d');
                data.paths.forEach(path => drawPath(offCtx, path));

                const imgDataURL = offCanvas.toDataURL('image/png');
                const imgBytes = await fetch(imgDataURL).then(r => r.arrayBuffer());
                const embeddedImg = await pdfDoc.embedPng(imgBytes);
                page.drawImage(embeddedImg, {
                    x: 0, y: 0,
                    width: pdfW, height: pdfH,
                    opacity: 1
                });
            }

            // Objects: stamps, text, images
            for (const obj of (data.objects || [])) {
                const xRatio = obj.x / canvasW;
                const yRatio = obj.y / canvasH;
                const pdfX = xRatio * pdfW;
                const pdfY = pdfH - (yRatio * pdfH) - 24;

                if (obj.type === 'stamp' || obj.type === 'text') {
                    const helvetica = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
                    const fontSize = obj.type === 'stamp' ? 14 : (obj.size || 16);
                    const [r, g, b] = hexToRgbFloat(obj.color);
                    page.drawText(obj.text, {
                        x: pdfX, y: pdfY,
                        size: fontSize,
                        font: helvetica,
                        color: PDFLib.rgb(r, g, b)
                    });
                } else if (obj.type === 'image' || obj.type === 'signature') {
                    try {
                        const imgBytes = await fetch(obj.src).then(r => r.arrayBuffer());
                        let embeddedImg;
                        if (obj.src.includes('image/png') || obj.src.includes('data:image/png')) {
                            embeddedImg = await pdfDoc.embedPng(imgBytes);
                        } else {
                            embeddedImg = await pdfDoc.embedJpg(imgBytes);
                        }
                        const imgW = (obj.width / canvasW) * pdfW;
                        const imgH = imgW * (embeddedImg.height / embeddedImg.width);
                        page.drawImage(embeddedImg, {
                            x: pdfX, y: pdfY - imgH,
                            width: imgW, height: imgH
                        });
                    } catch (imgErr) {
                        // Skip image that can't be embedded
                    }
                }
            }
        }

        const savedBytes = await pdfDoc.save();
        downloadBlob(new Blob([savedBytes], { type: 'application/pdf' }), 'annotated.pdf');
        showToast('Annotated PDF downloaded!');
    } catch (err) {
        showToast('Download failed: ' + err.message);
    } finally {
        hideLoading();
    }
}

// =====================================================================
// UTILITIES
// =====================================================================
function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
}

function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function hexToRgbFloat(hex) {
    hex = hex.replace(/^#/, '');
    if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
    if (hex.length !== 6) return [0, 0, 0];
    const r = parseInt(hex.substring(0, 2), 16) / 255;
    const g = parseInt(hex.substring(2, 4), 16) / 255;
    const b = parseInt(hex.substring(4, 6), 16) / 255;
    return [r, g, b];
}

// Close modal on backdrop click
document.querySelectorAll('.modal-backdrop').forEach(bd => {
    bd.addEventListener('click', e => { if (e.target === bd) bd.classList.add('hidden'); });
});
</script>
</body>
</html>
